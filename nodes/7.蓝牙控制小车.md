# 一、硬件原理图阅读

![图片描述](https://img.mukewang.com/wiki/6405bc8c0932a8c210861280.jpg)



# 二、蓝牙测试



## 1.相关命令

```plain
1.查询蓝牙名称
命令:
AT+NAME?\r\n

回应:
AT+NAME?
+NAME:@220514EED2
OK

2.设置蓝牙名称
命令:
AT+NAME="SmartCarBT"\r\n

回应:
AT+NAME="SmartCarBT"
OK
```



## 2.微信小程序测试



### (1)搜索蓝牙串口

![图片描述](https://img.mukewang.com/wiki/6405bca00942ef6b12422208.jpg)



### (2)连接蓝牙

![图片描述](https://img.mukewang.com/wiki/6405bcb40968ca8912422208.jpg)



### (3)发送数据

![图片描述](https://img.mukewang.com/wiki/6405bccb0918608812422208.jpg)

### 测试结果

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/cdfbbde4ff974e6f89c61d42b528e27e.png)

# 三、蓝牙操作小车

```c
#include "usart.h"
#include "tim.h"
#include "smartcar.h"
#include <stdio.h>
#include <string.h>

void bluetooth_car_control(uint8_t *buffer,uint32_t size)
{
        int ret;
        
        switch(buffer[0]){
                case 'w':
                        car_forward(800);
                        printf("forward\r\n");
                 break;
                
         case 's':
                  car_reverse(800);
                        printf("reverse\r\n");
                  break;
        case 'a':
                  car_turn_left(800);
                        printf("turn left\r\n");
                  break;
        
        case 'd':
                  car_turn_right(800);
                        printf("turn right\r\n");
                  break;
        }
        
        __HAL_TIM_SET_COUNTER(&htim4,0);
        __HAL_TIM_CLEAR_FLAG(&htim4,TIM_FLAG_UPDATE);
        HAL_TIM_Base_Start_IT(&htim4);
        
        return;
}

void bluetooth_test(void)
{
        uart_interrupt_init();
        return;
}
void HAL_UARTEx_RxEventCallback(UART_HandleTypeDef *huart, uint16_t Size)
{
  int i;
        void esp8266_control_car(uint8_t *buffer,uint32_t size);
        
        if(huart == &huart1){
             //recv data to uart2
             HAL_UART_Transmit(&huart2,uart1_rx_buffer,Size,HAL_MAX_DELAY);
             HAL_UARTEx_ReceiveToIdle_IT(&huart1,uart1_rx_buffer,sizeof(uart1_rx_buffer));
         }else if(huart == &huart2){
             bluetooth_car_control(uart2_rx_buffer,Size);
             //esp8266_car_control(uart2_rx_buffer,Size);
             HAL_UART_Transmit(&huart1,uart2_rx_buffer,Size,HAL_MAX_DELAY);
             HAL_UARTEx_ReceiveToIdle_IT(&huart2,uart2_rx_buffer,sizeof(uart2_rx_buffer));
         }
        
         return;
}  
```